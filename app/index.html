<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pactown Live Debug</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --accent-red: #ff3366;
            --accent-green: #00ff88;
            --accent-blue: #00aaff;
            --accent-yellow: #ffcc00;
            --accent-purple: #aa66ff;
            --text-primary: #f0f0f5;
            --text-secondary: #8888aa;
            --text-muted: #555566;
            --border-color: #2a2a3a;
            --error-bg: rgba(255, 51, 102, 0.1);
            --success-bg: rgba(0, 255, 136, 0.1);
            --warning-bg: rgba(255, 204, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated background */
        .bg-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 170, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 170, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            box-shadow: 0 0 30px rgba(0, 170, 255, 0.3);
        }

        .logo h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo span {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 30px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 10px var(--accent-green); }
            50% { opacity: 0.5; box-shadow: 0 0 5px var(--accent-green); }
        }

        /* Main editor area */
        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            flex: 1;
        }

        .panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            border-radius: 16px 16px 0 0;
        }

        .panel.input::before {
            background: linear-gradient(90deg, var(--accent-red), var(--accent-yellow));
        }

        .panel.output::before {
            background: linear-gradient(90deg, var(--accent-green), var(--accent-blue));
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }

        .panel-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 600;
        }

        .panel-title-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 16px;
        }

        .panel.input .panel-title-icon {
            background: rgba(255, 51, 102, 0.2);
            color: var(--accent-red);
        }

        .panel.output .panel-title-icon {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
        }

        .panel-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 170, 255, 0.4);
        }

        .btn-secondary {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--accent-blue);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--accent-green), #00cc70);
            color: var(--bg-primary);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
        }

        /* Code editor */
        .code-area {
            flex: 1;
            display: flex;
            position: relative;
        }

        .line-numbers {
            padding: 20px 15px;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            text-align: right;
            user-select: none;
            border-right: 1px solid var(--border-color);
            min-width: 50px;
            white-space: pre;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .line-number {
            line-height: 1.6;
        }

        .code-input {
            flex: 1;
            padding: 20px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            outline: none;
            white-space: pre;
            overflow-x: auto;
        }

        .code-input::placeholder {
            color: var(--text-muted);
        }

        .code-output {
            flex: 1;
            padding: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            overflow: auto;
        }

        .btn-toggle-active {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(0, 170, 255, 0.15);
        }

        .code-output.markdown-preview {
            font-family: 'Space Grotesk', sans-serif;
            line-height: 1.7;
        }

        .code-output.markdown-preview h1,
        .code-output.markdown-preview h2,
        .code-output.markdown-preview h3,
        .code-output.markdown-preview h4,
        .code-output.markdown-preview h5,
        .code-output.markdown-preview h6 {
            margin: 18px 0 10px;
            font-weight: 700;
        }

        .code-output.markdown-preview p {
            margin: 10px 0;
            color: var(--text-primary);
        }

        .code-output.markdown-preview ul {
            margin: 10px 0 10px 22px;
        }

        .code-output.markdown-preview li {
            margin: 6px 0;
        }

        .code-output.markdown-preview a {
            color: var(--accent-blue);
            text-decoration: none;
        }

        .code-output.markdown-preview a:hover {
            text-decoration: underline;
        }

        .code-output.markdown-preview code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 2px 6px;
        }

        .code-output.markdown-preview pre {
            margin: 14px 0;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: auto;
        }

        .code-output.markdown-preview pre code {
            background: transparent;
            border: none;
            padding: 0;
            border-radius: 0;
            white-space: pre;
        }

        /* Syntax highlighting */
        .code-line {
            display: block;
            padding: 2px 0;
        }

        .code-line.error {
            background: var(--error-bg);
            border-left: 3px solid var(--accent-red);
            margin-left: -20px;
            padding-left: 17px;
        }

        .code-line.fixed {
            background: var(--success-bg);
            border-left: 3px solid var(--accent-green);
            margin-left: -20px;
            padding-left: 17px;
        }

        .code-line.warning {
            background: var(--warning-bg);
            border-left: 3px solid var(--accent-yellow);
            margin-left: -20px;
            padding-left: 17px;
        }

        .comment {
            color: var(--accent-green);
            font-style: italic;
        }

        .keyword {
            color: var(--accent-purple);
        }

        .string {
            color: var(--accent-yellow);
        }

        .variable {
            color: var(--accent-blue);
        }

        .command {
            color: var(--accent-red);
        }

        /* Error annotations */
        .error-annotation {
            display: block;
            color: var(--accent-red);
            font-size: 12px;
            padding: 5px 0 5px 25px;
            background: var(--error-bg);
            margin: 5px 0;
            border-radius: 4px;
        }

        .warning-annotation {
            display: block;
            color: var(--accent-yellow);
            font-size: 12px;
            padding: 5px 0 5px 25px;
            background: var(--warning-bg);
            margin: 5px 0;
            border-radius: 4px;
        }

        .fix-annotation {
            display: block;
            color: var(--accent-green);
            font-size: 12px;
            padding: 5px 0 5px 25px;
            background: var(--success-bg);
            margin: 5px 0;
            border-radius: 4px;
        }

        .apply-fix-btn {
            margin-left: 10px;
            padding: 2px 8px;
            font-size: 11px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
        }

        .apply-fix-btn:hover {
            border-color: var(--accent-green);
        }

        /* History panel */
        .history-panel {
            margin-top: 30px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
        }

        .history-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }

        .history-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 600;
        }

        .history-content {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px 25px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s ease;
            cursor: pointer;
        }

        .history-item:hover {
            background: var(--bg-tertiary);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-time {
            font-size: 12px;
            color: var(--text-muted);
            min-width: 80px;
        }

        .history-type {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .history-type.fix {
            background: rgba(0, 255, 136, 0.2);
            color: var(--accent-green);
        }

        .history-type.error {
            background: rgba(255, 51, 102, 0.2);
            color: var(--accent-red);
        }

        .history-type.warning {
            background: rgba(255, 204, 0, 0.2);
            color: var(--accent-yellow);
        }

        .history-message {
            flex: 1;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .history-message code {
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        /* Stats bar */
        .stats-bar {
            display: flex;
            gap: 30px;
            padding: 15px 25px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .stat-value {
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-value.errors {
            color: var(--accent-red);
        }

        .stat-value.fixed {
            color: var(--accent-green);
        }

        .stat-value.warnings {
            color: var(--accent-yellow);
        }

        /* Loading spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        .analyzing .spinner {
            display: block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
            color: var(--text-muted);
            text-align: center;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state p {
            max-width: 300px;
            line-height: 1.6;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .editor-container {
                grid-template-columns: 1fr;
            }
            
            .panel {
                min-height: 400px;
            }
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: var(--accent-green);
        }

        .toast.error {
            border-color: var(--accent-red);
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">‚ö°</div>
                <div>
                    <h1>Pactown Live Debug</h1>
                    <span>Real-time Bash & Shell Script Analyzer</span>
                </div>
            </div>
            <div class="status-badge">
                <div class="status-dot"></div>
                <span>ShellCheck Active</span>
            </div>
        </header>

        <div class="editor-container">
            <!-- Input Panel -->
            <div class="panel input">
                <div class="panel-header">
                    <div class="panel-title">
                        <div class="panel-title-icon">üìù</div>
                        <span id="inputTitleText">Wej≈õcie - Wklej kod z b≈Çƒôdami</span>
                    </div>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" id="modeCodeBtn" onclick="setMode('code')">
                            üíª Kod
                        </button>
                        <button class="btn btn-secondary" id="modeMarkdownBtn" onclick="setMode('markdown')">
                            üßæ Markdown
                        </button>
                        <button class="btn btn-secondary" onclick="clearInput()">
                            üóëÔ∏è Wyczy≈õƒá
                        </button>
                        <button class="btn btn-secondary" onclick="loadExample()">
                            üìã Bash
                        </button>
                        <button class="btn btn-secondary" onclick="loadPythonExample()">
                            üêç Python
                        </button>
                        <button class="btn btn-secondary" onclick="loadMarkdownExample()">
                            üßæ Przyk≈Çad
                        </button>
                    </div>
                </div>
                <div class="code-area">
                    <div class="line-numbers" id="inputLineNumbers">1</div>
                    <textarea 
                        class="code-input" 
                        id="codeInput" 
                        placeholder="Wklej sw√≥j skrypt Bash tutaj...&#10;&#10;B≈Çƒôdy zostanƒÖ automatycznie wykryte i naprawione."
                        spellcheck="false"
                    ></textarea>
                </div>
                <div class="stats-bar">
                    <div class="stat">
                        <span>Linie:</span>
                        <span class="stat-value" id="lineCount">0</span>
                    </div>
                    <div class="stat">
                        <span>Znaki:</span>
                        <span class="stat-value" id="charCount">0</span>
                    </div>
                    <div class="stat">
                        <div class="spinner"></div>
                        <span id="analyzeStatus">Gotowy do analizy</span>
                    </div>
                </div>
            </div>

            <!-- Output Panel -->
            <div class="panel output">
                <div class="panel-header">
                    <div class="panel-title">
                        <div class="panel-title-icon">‚úÖ</div>
                        <span id="outputTitleText">Wyj≈õcie - Poprawiony kod</span>
                        <span id="languageBadge" class="language-badge" style="display:none; margin-left: 10px; padding: 4px 8px; background: var(--bg-primary); border-radius: 4px; font-size: 12px; color: var(--accent-blue);"></span>
                    </div>
                    <div class="panel-actions">
                        <button class="btn btn-secondary" id="outputViewPreviewBtn" onclick="setOutputView('preview')" style="display:none;">
                            üëÅÔ∏è PodglƒÖd
                        </button>
                        <button class="btn btn-secondary" id="outputViewCodeBtn" onclick="setOutputView('code')" style="display:none;">
                            üßæ Tekst
                        </button>
                        <button class="btn btn-secondary" onclick="copyOutput()">
                            üìã Kopiuj
                        </button>
                        <button class="btn btn-secondary" onclick="applyAllFixesToInput()">
                            ü™Ñ Zastosuj poprawki
                        </button>
                        <button class="btn btn-success" onclick="downloadOutput()">
                            ‚¨áÔ∏è Pobierz
                        </button>
                    </div>
                </div>
                <div class="code-area">
                    <div class="line-numbers" id="outputLineNumbers">1</div>
                    <div class="code-output" id="codeOutput">
                        <div class="empty-state">
                            <div class="empty-state-icon">üîç</div>
                            <p>Wklej kod w lewym panelu, aby zobaczyƒá analizƒô i poprawki w czasie rzeczywistym.</p>
                        </div>
                    </div>
                </div>
                <div class="stats-bar">
                    <div class="stat">
                        <span>B≈Çƒôdy:</span>
                        <span class="stat-value errors" id="errorCount">0</span>
                    </div>
                    <div class="stat">
                        <span>Naprawione:</span>
                        <span class="stat-value fixed" id="fixedCount">0</span>
                    </div>
                    <div class="stat">
                        <span>Ostrze≈ºenia:</span>
                        <span class="stat-value warnings" id="warningCount">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Panel -->
        <div class="history-panel">
            <div class="history-header">
                <div class="history-title">
                    <span>üìú</span>
                    <span>Historia zmian</span>
                </div>
                <button class="btn btn-secondary" onclick="clearHistory()">
                    üóëÔ∏è Wyczy≈õƒá historiƒô
                </button>
            </div>
            <div class="history-content" id="historyContent">
                <div class="empty-state" style="padding: 40px;">
                    <p>Historia zmian pojawi siƒô tutaj po analizie kodu.</p>
                </div>
            </div>
        const outputLineNumbers = document.getElementById('outputLineNumbers');
        const historyContent = document.getElementById('historyContent');
        const inputTitleText = document.getElementById('inputTitleText');
        const outputTitleText = document.getElementById('outputTitleText');
        const modeCodeBtn = document.getElementById('modeCodeBtn');
        const modeMarkdownBtn = document.getElementById('modeMarkdownBtn');
        const outputViewPreviewBtn = document.getElementById('outputViewPreviewBtn');
        const outputViewCodeBtn = document.getElementById('outputViewCodeBtn');

        // Initialize
        codeInput.addEventListener('input', handleInput);
        codeInput.addEventListener('scroll', syncScroll);
        window.addEventListener('hashchange', () => {
            loadFromHash();
        });

        function setMode(mode) {
            currentMode = mode === 'markdown' ? 'markdown' : 'code';
            if (currentMode === 'markdown') {
                inputTitleText.textContent = 'Wej≈õcie - Markdown';
                outputTitleText.textContent = 'Wyj≈õcie - PodglƒÖd Markdown';
                codeInput.placeholder = 'Wklej Markdown tutaj...\n\nZawarto≈õƒá blok√≥w ``` zostanie przeanalizowana i naprawiona.';
                outputViewPreviewBtn.style.display = 'inline-flex';
                outputViewCodeBtn.style.display = 'inline-flex';
                setOutputView('preview', { skipAnalyze: true });
            } else {
                inputTitleText.textContent = 'Wej≈õcie - Wklej kod z b≈Çƒôdami';
                outputTitleText.textContent = 'Wyj≈õcie - Poprawiony kod';
                codeInput.placeholder = 'Wklej sw√≥j skrypt Bash tutaj...\n\nB≈Çƒôdy zostanƒÖ automatycznie wykryte i naprawione.';
                outputViewPreviewBtn.style.display = 'none';
                outputViewCodeBtn.style.display = 'none';
                setOutputView('code', { skipAnalyze: true });
            }
            modeCodeBtn.classList.toggle('btn-toggle-active', currentMode === 'code');
            modeMarkdownBtn.classList.toggle('btn-toggle-active', currentMode === 'markdown');
            handleInput();
        }

        function setOutputView(view, opts = {}) {
            outputView = view === 'preview' ? 'preview' : 'code';
            outputViewPreviewBtn.classList.toggle('btn-toggle-active', outputView === 'preview');
            outputViewCodeBtn.classList.toggle('btn-toggle-active', outputView === 'code');

            if (!opts.skipAnalyze && lastAnalysis) {
                displayResult(lastAnalysis);
            }
        }

        function handleInput() {
            updateStats();
            updateLineNumbers();
            scheduleShareUpdate();
            
            // Debounce analysis
            clearTimeout(debounceTimer);
            document.querySelector('.stats-bar').classList.add('analyzing');
            document.getElementById('analyzeStatus').textContent = 'Analizowanie...';
            
            debounceTimer = setTimeout(() => {
                analyzeCode();
            }, 300);
        }

        function updateStats() {
            const code = codeInput.value;
            const lines = code.split('\n').length;
            document.getElementById('lineCount').textContent = lines;
            document.getElementById('charCount').textContent = code.length;
        }

        function renderLineNumbers(container, lines) {
            let html = '';
            const count = Math.max(1, lines || 1);
            for (let i = 1; i <= count; i++) {
                html += `<span class="line-number">${i}</span>`;
            }
            container.innerHTML = html;
        }

        function updateLineNumbers() {
            const code = codeInput.value;
            const lines = code.split('\n').length;
            renderLineNumbers(inputLineNumbers, lines);
        }

        function syncScroll() {
            inputLineNumbers.scrollTop = codeInput.scrollTop;
        }

        function getHashId() {
            const raw = (window.location.hash || '').replace(/^#/, '').trim();
            if (/^[a-fA-F0-9]{64}$/.test(raw)) return raw.toLowerCase();
            return null;
        }

        function setHashId(id) {
            if (!id) return;
            const next = `${window.location.pathname}${window.location.search}#${id}`;
            history.replaceState(null, '', next);
        }

        function clearHashId() {
            const next = `${window.location.pathname}${window.location.search}`;
            history.replaceState(null, '', next);
        }

        function scheduleShareUpdate() {
            if (isLoadingFromHash) return;
            clearTimeout(shareDebounceTimer);
            shareDebounceTimer = setTimeout(() => {
                persistSnippet();
            }, 800);
        }

        async function persistSnippet() {
            if (isLoadingFromHash) return;
            const raw = codeInput.value;
            const trimmed = raw.trim();
            if (!trimmed) {
                currentSnippetId = null;
                clearHashId();
                return;
            }

            try {
                const response = await fetch('/api/snippet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: raw, mode: currentMode })
                });
                const data = await response.json();
                const id = data && typeof data.id === 'string' ? data.id : null;
                if (id && id !== currentSnippetId) {
                    currentSnippetId = id;
                    setHashId(id);
                }
            } catch (_e) {
            }
        }

        async function loadFromHash() {
            const id = getHashId();
            if (!id) return false;
            if (id === currentSnippetId) return true;

            isLoadingFromHash = true;
            try {
                const response = await fetch(`/api/snippet/${id}`);
                if (!response.ok) return false;
                const data = await response.json();
                const code = data && typeof data.code === 'string' ? data.code : '';
                const mode = data && typeof data.mode === 'string' ? data.mode : null;

                codeInput.value = code;
                currentSnippetId = id;

                if (mode === 'markdown') setMode('markdown');
                else setMode('code');

                return true;
            } catch (_e) {
                return false;
            } finally {
                isLoadingFromHash = false;
            }
        }

        async function analyzeCode() {
            const code = codeInput.value.trim();
            
            if (!code) {
                lastAnalysis = null;
                codeOutput.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>Wklej kod w lewym panelu, aby zobaczyƒá analizƒô i poprawki w czasie rzeczywistym.</p>
                    </div>
                `;
                renderLineNumbers(outputLineNumbers, 1);
                outputLineNumbers.style.display = '';
                codeOutput.classList.remove('markdown-preview');
                document.getElementById('errorCount').textContent = '0';
                document.getElementById('fixedCount').textContent = '0';
                document.getElementById('warningCount').textContent = '0';
                document.querySelector('.stats-bar').classList.remove('analyzing');
                document.getElementById('analyzeStatus').textContent = 'Gotowy do analizy';
                return;
            }

            try {
                const payload = { code };
                if (currentMode === 'markdown') payload.language = 'markdown';
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                lastAnalysis = result;
                
                displayResult(result);
                updateHistory(result);
                
                document.getElementById('errorCount').textContent = result.errors?.length || 0;
                document.getElementById('fixedCount').textContent = result.fixes?.length || 0;
                document.getElementById('warningCount').textContent = result.warnings?.length || 0;
                
                // Show detected language
                const langBadge = document.getElementById('languageBadge');
                if (result.language) {
                    langBadge.textContent = result.language.toUpperCase();
                    langBadge.style.display = 'inline';
                } else {
                    langBadge.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Analysis error:', error);
                showToast('B≈ÇƒÖd po≈ÇƒÖczenia z serwerem', 'error');
            }
            
            document.querySelector('.stats-bar').classList.remove('analyzing');
            document.getElementById('analyzeStatus').textContent = 'Analiza zako≈Ñczona';
        }

        function displayResult(result) {
            if (!result.fixedCode) {
                codeOutput.innerHTML = '<div class="empty-state"><p>Brak poprawek do wy≈õwietlenia</p></div>';
                return;
            }

            if (currentMode === 'markdown' && outputView === 'preview') {
                outputLineNumbers.style.display = 'none';
                codeOutput.classList.add('markdown-preview');
                codeOutput.innerHTML = renderMarkdown(result.fixedCode);
                return;
            }

            outputLineNumbers.style.display = '';
            codeOutput.classList.remove('markdown-preview');

            let html = '';
            let lineNumber = 1;
            const lines = result.fixedCode.split('\n');

            lines.forEach((line, index) => {
                const lineNum = index + 1;
                
                // Check if this line has an error
                const errors = (result.errors || []).filter(e => e.line === lineNum);
                const fixes = (result.fixes || []).filter(f => f.line === lineNum);
                const warnings = (result.warnings || []).filter(w => w.line === lineNum);
                
                let lineClass = '';
                if (errors.length) lineClass = 'error';
                else if (fixes.length) lineClass = 'fixed';
                else if (warnings.length) lineClass = 'warning';
                
                // Syntax highlight the line
                const highlighted = highlightSyntax(line);
                
                html += `<span class="code-line ${lineClass}">${highlighted}</span>\n`;
                
                // Add annotation if there's a fix
                fixes.forEach((fix, fixIndex) => {
                    if (fix && fix.message) {
                        const hint = fix.after ? `Poprawna linia: ${fix.after}` : '';
                        const titleAttr = hint ? ` title="${escapeAttribute(hint)}"` : '';
                        html += `<span class="fix-annotation"${titleAttr}>‚úÖ ${escapeHtml(fix.message)} <button class="apply-fix-btn" onclick="applyFixForLine(${lineNum}, ${fixIndex})">Zastosuj</button></span>\n`;
                    }
                });
                
                // Add error annotation
                errors.forEach(error => {
                    if (error && error.message) {
                        html += `<span class="error-annotation">‚ùå ${escapeHtml(error.message)}</span>\n`;
                    }
                });
                
                // Add warning annotation
                warnings.forEach(warning => {
                    if (warning && warning.message) {
                        const hintFix = fixes.find(f => f && f.after);
                        const hint = hintFix ? `Poprawna linia: ${hintFix.after}` : '';
                        const titleAttr = hint ? ` title="${escapeAttribute(hint)}"` : '';
                        html += `<span class="warning-annotation"${titleAttr}>‚ö†Ô∏è ${escapeHtml(warning.message)}</span>\n`;
                    }
                });
            });

            renderLineNumbers(outputLineNumbers, lines.length);
            codeOutput.innerHTML = html;
        }

        function renderMarkdown(md) {
            const lines = (md || '').split('\n');
            let html = '';
            let inFence = false;
            let inList = false;

            const closeList = () => {
                if (inList) {
                    html += '</ul>';
                    inList = false;
                }
            };

            for (const line of lines) {
                const trimmed = line.trim();

                if (!inFence && trimmed.startsWith('```')) {
                    closeList();
                    inFence = true;
                    const lang = trimmed.slice(3).trim();
                    const cls = lang ? ` language-${escapeHtml(lang)}` : '';
                    html += `<pre><code class="md-code${cls}">`;
                    continue;
                }

                if (inFence) {
                    if (trimmed.startsWith('```')) {
                        html += '</code></pre>';
                        inFence = false;
                    } else {
                        html += `${escapeHtml(line)}\n`;
                    }
                    continue;
                }

                const headingMatch = line.match(/^(#{1,6})\s+(.+)$/);
                if (headingMatch) {
                    closeList();
                    const level = headingMatch[1].length;
                    html += `<h${level}>${renderInlineMarkdown(headingMatch[2])}</h${level}>`;
                    continue;
                }

                const listMatch = line.match(/^\s*[-*]\s+(.+)$/);
                if (listMatch) {
                    if (!inList) {
                        html += '<ul>';
                        inList = true;
                    }
                    html += `<li>${renderInlineMarkdown(listMatch[1])}</li>`;
                    continue;
                }

                if (!trimmed) {
                    closeList();
                    continue;
                }

                closeList();
                html += `<p>${renderInlineMarkdown(line)}</p>`;
            }

            closeList();
            if (inFence) html += '</code></pre>';
            return html;
        }

        function renderInlineMarkdown(text) {
            const s = String(text ?? '');
            let out = '';
            let last = 0;
            const re = /`([^`]+)`/g;
            let m;
            while ((m = re.exec(s)) !== null) {
                out += escapeHtml(s.slice(last, m.index));
                out += `<code>${escapeHtml(m[1])}</code>`;
                last = m.index + m[0].length;
            }
            out += escapeHtml(s.slice(last));

            out = out.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            out = out.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            out = out.replace(/\[([^\]]+)\]\(([^)]+)\)/g, (_m, label, url) => {
                return `<a href="${escapeAttribute(url)}" target="_blank" rel="noopener noreferrer">${label}</a>`;
            });

            return out;
        }

        function highlightSyntax(line) {
            const keywords = ['if', 'then', 'else', 'elif', 'fi', 'for', 'do', 'done', 'while', 'until', 'case', 'esac', 'function', 'return', 'local', 'export', 'source', 'in'];
            const kwPattern = `\\b(?:${keywords.join('|')})\\b`;
            const varPattern = `(\\$\\{[^}]+\\}|\\$[a-zA-Z_][a-zA-Z0-9_]*)`;
            const tokenRe = new RegExp(`${varPattern}|${kwPattern}`, 'g');
            const strRe = /("(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*')/g;

            function splitComment(s) {
                let inS = false;
                let inD = false;
                for (let i = 0; i < s.length; i++) {
                    const ch = s[i];
                    const prev = i > 0 ? s[i - 1] : '';
                    if (ch === '"' && !inS && prev !== '\\') inD = !inD;
                    else if (ch === "'" && !inD && prev !== '\\') inS = !inS;
                    else if (ch === '#' && !inS && !inD) return [s.slice(0, i), s.slice(i)];
                }
                return [s, ''];
            }

            function highlightPlain(s) {
                let out = '';
                let last = 0;
                s.replace(tokenRe, (m, varTok, offset) => {
                    out += escapeHtml(s.slice(last, offset));
                    if (m.startsWith('$')) out += `<span class="variable">${escapeHtml(m)}</span>`;
                    else out += `<span class="keyword">${escapeHtml(m)}</span>`;
                    last = offset + m.length;
                    return m;
                });
                out += escapeHtml(s.slice(last));
                return out;
            }

            function highlightCode(s) {
                let html = '';
                const cmdMatch = s.match(/^(\s*)([a-zA-Z_][a-zA-Z0-9_-]*)/);
                let rest = s;
                if (cmdMatch) {
                    html += escapeHtml(cmdMatch[1]);
                    html += `<span class="command">${escapeHtml(cmdMatch[2])}</span>`;
                    rest = s.slice(cmdMatch[0].length);
                }
                let last = 0;
                rest.replace(strRe, (m, _g1, offset) => {
                    html += highlightPlain(rest.slice(last, offset));
                    html += `<span class="string">${escapeHtml(m)}</span>`;
                    last = offset + m.length;
                    return m;
                });
                html += highlightPlain(rest.slice(last));
                return html;
            }

            const [codePart, commentPart] = splitComment(line);
            let html = highlightCode(codePart);
            if (commentPart) html += `<span class="comment">${escapeHtml(commentPart)}</span>`;
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeAttribute(text) {
            return escapeHtml(String(text ?? '')).replace(/"/g, '&quot;');
        }

        function updateHistory(result) {
            const timestamp = new Date().toLocaleTimeString('pl-PL');
            
            // Add errors to history
            result.errors?.forEach(error => {
                history.unshift({
                    time: timestamp,
                    type: 'error',
                    message: `Linia ${error.line}: ${error.message}`,
                    code: error.code
                });
            });
            
            // Add fixes to history
            result.fixes?.forEach(fix => {
                history.unshift({
                    time: timestamp,
                    type: 'fix',
                    message: `Linia ${fix.line}: ${fix.message}`,
                    before: fix.before,
                    after: fix.after
                });
            });
            
            // Add warnings to history
            result.warnings?.forEach(warning => {
                history.unshift({
                    time: timestamp,
                    type: 'warning',
                    message: `Linia ${warning.line}: ${warning.message}`,
                    code: warning.code
                });
            });
            
            // Keep only last 50 items
            history = history.slice(0, 50);
            
            renderHistory();
        }

        function renderHistory() {
            if (history.length === 0) {
                historyContent.innerHTML = `
                    <div class="empty-state" style="padding: 40px;">
                        <p>Historia zmian pojawi siƒô tutaj po analizie kodu.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            history.forEach((item, index) => {
                html += `
                    <div class="history-item" onclick="showHistoryDetail(${index})">
                        <span class="history-time">${item.time}</span>
                        <span class="history-type ${item.type}">${item.type === 'fix' ? 'Naprawiono' : item.type === 'error' ? 'B≈ÇƒÖd' : 'Ostrze≈ºenie'}</span>
                        <span class="history-message">${escapeHtml(item.message)}</span>
                    </div>
                `;
            });
            
            historyContent.innerHTML = html;
        }

        function showHistoryDetail(index) {
            const item = history[index];
            if (item.before && item.after) {
                showToast(`Zmieniono: "${item.before}" ‚Üí "${item.after}"`, 'success');
            }
        }

        function clearInput() {
            codeInput.value = '';
            handleInput();
        }

        function loadMarkdownExample() {
            setMode('markdown');
            codeInput.value = `# Example README\n\nThis document includes multiple fenced code blocks.\n\n\`\`\`bash\nexport TOKEN=hardcoded\nif [ -z \"$TOKEN\" ]; then\n  echo \"missing\"\nfi\n\`\`\`\n\n\`\`\`python\ndef process_data(items=[]):\n    for item in items:\n        if item == None:\n            print \"Item is None\"\n\`\`\`\n\n\`\`\`dockerfile\nFROM ubuntu:latest\nRUN apt-get update\n\`\`\``;
            handleInput();
        }

        function loadExample() {
            setMode('code');
            codeInput.value = `#!/usr/bin/bash
OUTPUT=/home/student/output-

for HOST in server{a,b}; do
    if test -f $OUTPUT/$HOST; then
        rm -v $OUTPUT/$HOST
    fi
    echo "$(ssh student@$HOST hostname -f") >> $OUTPUT/$HOST
    echo "#####"
    ssh student@$HOST lscpu | grep "^CPU" >> $OUTPUT/$HOST
done

echo "Zako≈Ñczono"`;
            handleInput();
        }

        function loadPythonExample() {
            setMode('code');
            codeInput.value = `#!/usr/bin/env python3
import os
import sys

def process_data(items=[]):
    for item in items:
        if item == None:
            print "Item is None"
            continue
        try:
            result = item * 2
        except:
            print "Error processing item"
    return items

if __name__ == "__main__":
    data = [1, 2, None, 4]
    process_data(data)`;
            handleInput();
        }

        async function copyOutput() {
            const text = (lastAnalysis && lastAnalysis.fixedCode) ? lastAnalysis.fixedCode : codeOutput.textContent;
            try {
                await navigator.clipboard.writeText(text);
                showToast('Skopiowano do schowka!', 'success');
            } catch (err) {
                showToast('B≈ÇƒÖd kopiowania', 'error');
            }
        }

        function downloadOutput() {
            const text = codeOutput.textContent;
            if (!text || text.includes('Wklej kod')) {
                showToast('Brak kodu do pobrania', 'error');
                return;
            }

            const lang = lastAnalysis && lastAnalysis.language ? String(lastAnalysis.language) : (currentMode === 'markdown' ? 'markdown' : 'bash');
            const extMap = {
                markdown: 'md',
                python: 'py',
                javascript: 'js',
                nodejs: 'js',
                bash: 'sh',
                dockerfile: 'Dockerfile',
                nginx: 'conf',
                terraform: 'tf',
                sql: 'sql',
                'docker-compose': 'yml',
                'github-actions': 'yml',
                ansible: 'yml'
            };
            const mimeMap = {
                markdown: 'text/markdown',
                python: 'text/x-python',
                javascript: 'text/javascript',
                nodejs: 'text/javascript',
                bash: 'text/x-shellscript'
            };

            const ext = extMap[lang] || 'txt';
            const mime = mimeMap[lang] || 'text/plain';
            const filename = ext === 'Dockerfile' ? 'Dockerfile' : `fixed.${ext}`;

            const blob = new Blob([text], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Pobieranie rozpoczƒôte!', 'success');
        }

        function _replaceLinePreservingIndent(lines, lineNum, newLine) {
            const idx = lineNum - 1;
            if (idx < 0 || idx >= lines.length) return;
            const indentMatch = lines[idx].match(/^\s*/);
            const indent = indentMatch ? indentMatch[0] : '';
            const withoutIndent = String(newLine || '').replace(/^\s*/, '');
            lines[idx] = indent + withoutIndent;
        }

        function applyFixForLine(lineNum, fixIndex = 0) {
            if (!lastAnalysis || !Array.isArray(lastAnalysis.fixes)) return;
            const lineFixes = lastAnalysis.fixes.filter(f => f && f.line === lineNum);
            const fix = lineFixes[fixIndex];
            if (!fix || !fix.after) return;

            const lines = codeInput.value.split('\n');
            _replaceLinePreservingIndent(lines, lineNum, fix.after);
            codeInput.value = lines.join('\n');
            handleInput();
            showToast(`Zastosowano poprawkƒô w linii ${lineNum}`, 'success');
        }

        function applyAllFixesToInput() {
            if (!lastAnalysis || !Array.isArray(lastAnalysis.fixes) || lastAnalysis.fixes.length === 0) {
                showToast('Brak poprawek do zastosowania', 'error');
                return;
            }
            const lines = codeInput.value.split('\n');
            lastAnalysis.fixes.forEach(fix => {
                if (!fix || !fix.line || !fix.after) return;
                _replaceLinePreservingIndent(lines, fix.line, fix.after);
            });
            codeInput.value = lines.join('\n');
            handleInput();
            showToast('Zastosowano wszystkie poprawki', 'success');
        }

        function clearHistory() {
            history = [];
            renderHistory();
            showToast('Historia wyczyszczona', 'success');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Initial state
        (async () => {
            const loaded = await loadFromHash();
            if (!loaded) setMode('code');
            updateStats();
            updateLineNumbers();
        })();
    </script>
</body>
</html>
